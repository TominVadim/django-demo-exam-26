<!-- templates/main/product_list.html -->
{% extends 'main/base.html' %}
{% load static %}

{% block title %}–ö–∞—Ç–∞–ª–æ–≥ —Ç–æ–≤–∞—Ä–æ–≤{% endblock %}

{% block content %}
<style>
/* –í—Å–µ —Å—Ç–∏–ª–∏ –ø—Ä—è–º–æ –≤ —à–∞–±–ª–æ–Ω–µ –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏ */
body {
    font-family: 'Times New Roman', serif;
    background-color: #FFFFFF;
    margin: 0;
    padding: 0;
}

.page-title {
    color: #333;
    margin-bottom: 30px;
    text-align: center;
}

/* –ü–∞–Ω–µ–ª—å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ */
.filter-panel {
    background-color: #f5f5f5;
    padding: 25px;
    border-radius: 10px;
    margin-bottom: 30px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.filter-panel form {
    display: flex;
    flex-wrap: wrap;
    gap: 20px;
    align-items: flex-end;
}

.filter-group {
    flex: 1;
    min-width: 200px;
}

.filter-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: bold;
    color: #333;
    font-size: 16px;
}

.search-input, .filter-select {
    width: 100%;
    padding: 12px;
    border: 2px solid #ddd;
    border-radius: 6px;
    font-size: 15px;
    font-family: 'Times New Roman', serif;
    transition: all 0.3s;
}

.search-input:focus, .filter-select:focus {
    outline: none;
    border-color: #00FA9A;
    box-shadow: 0 0 8px rgba(0,250,154,0.3);
}

.reset-button {
    background-color: #ff4444;
    color: white;
    padding: 12px 25px;
    text-decoration: none;
    border-radius: 6px;
    font-size: 15px;
    font-weight: bold;
    display: inline-block;
    transition: background-color 0.3s;
}

.reset-button:hover {
    background-color: #cc0000;
}

/* –ü–∞–Ω–µ–ª—å –¥–µ–π—Å—Ç–≤–∏–π */
.action-bar {
    margin-bottom: 25px;
    text-align: right;
}

.add-button {
    background-color: #00FA9A;
    color: black;
    padding: 12px 30px;
    border-radius: 6px;
    text-decoration: none;
    font-weight: bold;
    font-size: 16px;
    display: inline-block;
    transition: opacity 0.3s;
}

.add-button:hover {
    opacity: 0.8;
}

/* –°—á–µ—Ç—á–∏–∫ —Ç–æ–≤–∞—Ä–æ–≤ */
.product-count {
    margin-bottom: 20px;
    padding: 10px;
    background-color: #f0f0f0;
    border-radius: 5px;
    font-size: 15px;
    color: #555;
}

/* –°–µ—Ç–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤ */
.product-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: 30px;
    margin-top: 20px;
}

/* –ö–∞—Ä—Ç–æ—á–∫–∞ —Ç–æ–≤–∞—Ä–∞ */
.product-card {
    border: 1px solid #e0e0e0;
    padding: 20px;
    border-radius: 10px;
    background-color: #FFFFFF;
    box-shadow: 0 3px 10px rgba(0,0,0,0.1);
    transition: all 0.3s;
    position: relative;
}

.product-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 5px 20px rgba(0,0,0,0.15);
}

/* –ö–∞—Ä—Ç–æ—á–∫–∞ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ */
.admin-card {
    border: 2px solid transparent;
    cursor: pointer;
}

.admin-card:hover {
    border-color: #00FA9A;
}

/* –ö–∞—Ä—Ç–æ—á–∫–∞ —Å –±–æ–ª—å—à–µ–π —Å–∫–∏–¥–∫–æ–π */
.product-card.high-discount {
    background-color: #2E8B57 !important;
    color: white;
}

.product-card.high-discount .product-info p,
.product-card.high-discount .product-info strong,
.product-card.high-discount .product-price .new-price,
.product-card.high-discount .product-price .price {
    color: white;
}

.product-card.high-discount .product-info h3 {
    color: white;
    border-bottom-color: white;
}

.product-card.high-discount .old-price {
    color: #ffaaaa;
}

/* –¢–æ–≤–∞—Ä–∞ –Ω–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏ */
.product-card.out-of-stock {
    background-color: #ADD8E6;
}

/* –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ */
.product-image {
    height: 220px;
    display: flex;
    justify-content: center;
    align-items: center;
    margin-bottom: 15px;
    background-color: white;
    border-radius: 8px;
    padding: 15px;
    border: 1px solid #eee;
}

.product-image img {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
}

/* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–æ–≤–∞—Ä–µ */
.product-info h3 {
    margin: 0 0 15px 0;
    font-size: 20px;
    color: #333;
    border-bottom: 2px solid #00FA9A;
    padding-bottom: 8px;
}

.product-info p {
    margin: 10px 0;
    font-size: 15px;
    line-height: 1.5;
    color: #555;
}

.product-info strong {
    color: #333;
    min-width: 120px;
    display: inline-block;
}

/* –¶–µ–Ω–∞ */
.product-price {
    margin-top: 20px;
    padding-top: 15px;
    border-top: 2px solid #eee;
    font-weight: bold;
    font-size: 20px;
    text-align: center;
}

.old-price {
    text-decoration: line-through;
    color: #ff4444;
    margin-right: 15px;
    font-size: 18px;
}

.new-price {
    color: #000000;
    font-weight: bold;
    font-size: 24px;
}

.price {
    color: #000000;
    font-weight: bold;
    font-size: 24px;
}

/* –î–µ–π—Å—Ç–≤–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ */
.admin-actions {
    margin-top: 20px;
    display: flex;
    gap: 12px;
    justify-content: center;
    border-top: 1px solid #eee;
    padding-top: 15px;
}

.edit-btn, .delete-btn {
    padding: 8px 15px;
    border-radius: 5px;
    text-decoration: none;
    font-size: 14px;
    font-weight: bold;
    display: inline-block;
    transition: opacity 0.3s;
}

.edit-btn {
    background-color: #00FA9A;
    color: black;
}

.delete-btn {
    background-color: #ff4444;
    color: white;
}

.edit-btn:hover, .delete-btn:hover {
    opacity: 0.7;
}

/* –ù–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤ */
.no-products {
    text-align: center;
    padding: 60px;
    background-color: #f9f9f9;
    border-radius: 10px;
    width: 100%;
    grid-column: 1 / -1;
}

.no-products p {
    font-size: 20px;
    color: #666;
    margin-bottom: 25px;
}

/* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
@media (max-width: 768px) {
    .filter-panel form {
        flex-direction: column;
        gap: 15px;
    }
    
    .filter-group {
        width: 100%;
    }
    
    .product-grid {
        grid-template-columns: 1fr;
    }
}
</style>

<h1 class="page-title">–ö–∞—Ç–∞–ª–æ–≥ —Ç–æ–≤–∞—Ä–æ–≤</h1>

<!-- –ü–∞–Ω–µ–ª—å –ø–æ–∏—Å–∫–∞, —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ (–¥–ª—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞) -->
{% if user_role == 1 or user_role == 2 %}
<div class="filter-panel">
    <form method="get" action="{% url 'product_list' %}" id="filter-form">
        <!-- –ü–æ–∏—Å–∫ -->
        <div class="filter-group">
            <label for="search">üîç –ü–æ–∏—Å–∫:</label>
            <input type="text" 
                   name="search" 
                   id="search" 
                   value="{{ search_query }}" 
                   placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é, –∞—Ä—Ç–∏–∫—É–ª—É, –æ–ø–∏—Å–∞–Ω–∏—é..."
                   class="search-input">
        </div>
        
        <!-- –§–∏–ª—å—Ç—Ä –ø–æ –ø–æ—Å—Ç–∞–≤—â–∏–∫—É -->
        <div class="filter-group">
            <label for="provider">üè≠ –ü–æ—Å—Ç–∞–≤—â–∏–∫:</label>
            <select name="provider" id="provider" class="filter-select">
                <option value="">–í—Å–µ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∏</option>
                {% for provider in providers %}
                    <option value="{{ provider.id }}" {% if current_provider == provider.id|stringformat:"i" %}selected{% endif %}>
                        {{ provider.name }}
                    </option>
                {% endfor %}
            </select>
        </div>
        
        <!-- –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ -->
        <div class="filter-group">
            <label for="sort">üìä –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞:</label>
            <select name="sort" id="sort" class="filter-select">
                <option value="">–ë–µ–∑ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏</option>
                <option value="amount_asc" {% if current_sort == 'amount_asc' %}selected{% endif %}>
                    –ü–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É (–≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏–µ)
                </option>
                <option value="amount_desc" {% if current_sort == 'amount_desc' %}selected{% endif %}>
                    –ü–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É (—É–±—ã–≤–∞–Ω–∏–µ)
                </option>
            </select>
        </div>
        
        <!-- –ö–Ω–æ–ø–∫–∞ —Å–±—Ä–æ—Å–∞ -->
        <a href="{% url 'product_list' %}" class="reset-button">–°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã</a>
    </form>
</div>
{% endif %}

<!-- –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞ (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞) -->
{% if user_role == 1 %}
<div class="action-bar">
    <a href="{% url 'product_add' %}" class="add-button">+ –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π —Ç–æ–≤–∞—Ä</a>
</div>
{% endif %}

<!-- –°—á–µ—Ç—á–∏–∫ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤ -->
<div class="product-count">
    <strong>–ù–∞–π–¥–µ–Ω–æ —Ç–æ–≤–∞—Ä–æ–≤:</strong> {{ products|length }}
    {% if search_query %}
        –ø–æ –∑–∞–ø—Ä–æ—Å—É "{{ search_query }}"
    {% endif %}
    {% if current_provider %}
        {% for provider in providers %}
            {% if provider.id|stringformat:"i" == current_provider %}
                (–ø–æ—Å—Ç–∞–≤—â–∏–∫: {{ provider.name }})
            {% endif %}
        {% endfor %}
    {% endif %}
</div>

<!-- –°–µ—Ç–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤ -->
<div class="product-grid">
    {% for product in products %}
        <div class="product-card 
            {% if product.amount == 0 %}out-of-stock{% endif %}
            {% if product.discount > 15 %}high-discount{% endif %}
            {% if user_role == 1 %}admin-card{% endif %}"
            {% if user_role == 1 %}
                data-edit-url="{% url 'product_edit' product.id %}"
            {% endif %}>
            
            <div class="product-image">
                <img src="{% static 'main/products/' %}{{ product.photo|default:'picture.png' }}" 
                     alt="{{ product.name }}"
                     data-fallback="{% static 'main/products/picture.png' %}">
            </div>
            
            <div class="product-info">
                <h3>{{ product.name }}</h3>
                <p><strong>–ê—Ä—Ç–∏–∫—É–ª:</strong> {{ product.article }}</p>
                <p><strong>–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</strong> {{ product.category.name|default:"–ù–µ —É–∫–∞–∑–∞–Ω–∞" }}</p>
                <p><strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong> {{ product.description|default:"–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è"|truncatechars:50 }}</p>
                <p><strong>–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å:</strong> {{ product.producer.name|default:"–ù–µ —É–∫–∞–∑–∞–Ω" }}</p>
                <p><strong>–ü–æ—Å—Ç–∞–≤—â–∏–∫:</strong> {{ product.provider.name|default:"–ù–µ —É–∫–∞–∑–∞–Ω" }}</p>
                <p><strong>–ï–¥–∏–Ω–∏—Ü–∞ –∏–∑–º–µ—Ä–µ–Ω–∏—è:</strong> {{ product.unit.name|default:"—à—Ç." }}</p>
                <p><strong>–í –Ω–∞–ª–∏—á–∏–∏:</strong> {{ product.amount }} —à—Ç.</p>
                <p><strong>–°–∫–∏–¥–∫–∞:</strong> {{ product.discount }}%</p>
                
                <div class="product-price">
                    {% if product.discount > 0 %}
                        <span class="old-price">{{ product.price }} ‚ÇΩ</span>
                        <span class="new-price">{{ product.get_discounted_price|floatformat:2 }} ‚ÇΩ</span>
                    {% else %}
                        <span class="price">{{ product.price }} ‚ÇΩ</span>
                    {% endif %}
                </div>
                
                <!-- –ö–Ω–æ–ø–∫–∏ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ -->
                {% if user_role == 1 %}
                <div class="admin-actions" onclick="event.stopPropagation();">
                    <a href="{% url 'product_edit' product.id %}" class="edit-btn">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</a>
                    <a href="{% url 'product_delete' product.id %}" 
                       class="delete-btn"
                       onclick="return confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä ¬´{{ product.name }}¬ª?');">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</a>
                </div>
                {% endif %}
            </div>
        </div>
    {% empty %}
        <div class="no-products">
            <p>üòï –¢–æ–≤–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>
            {% if user_role == 1 %}
                <a href="{% url 'product_add' %}" class="add-button">‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–≤—ã–π —Ç–æ–≤–∞—Ä</a>
            {% else %}
                <a href="{% url 'product_list' %}" class="reset-button">–°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã</a>
            {% endif %}
        </div>
    {% endfor %}
</div>

<!-- –°–∫—Ä–∏–ø—Ç –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
        const searchInput = document.getElementById('search');
        const providerSelect = document.getElementById('provider');
        const sortSelect = document.getElementById('sort');
        const form = document.getElementById('filter-form');
        
        if (form) {
            // –ü–æ–∏—Å–∫ —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π
            let searchTimeout;
            searchInput.addEventListener('input', function() {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(function() {
                    form.submit();
                }, 500);
            });
            
            // –ú–≥–Ω–æ–≤–µ–Ω–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ select
            providerSelect.addEventListener('change', function() {
                form.submit();
            });
            
            sortSelect.addEventListener('change', function() {
                form.submit();
            });
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–æ–≤ –ø–æ –∫–∞—Ä—Ç–æ—á–∫–∞–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
        document.querySelectorAll('.admin-card').forEach(card => {
            card.addEventListener('click', function(e) {
                // –ù–µ —Ä–µ–∞–≥–∏—Ä—É–µ–º –Ω–∞ –∫–ª–∏–∫–∏ –ø–æ –∫–Ω–æ–ø–∫–∞–º –≤–Ω—É—Ç—Ä–∏ –∫–∞—Ä—Ç–æ—á–∫–∏
                if (e.target.closest('.admin-actions')) {
                    return;
                }
                
                const editUrl = this.getAttribute('data-edit-url');
                if (editUrl) {
                    window.location.href = editUrl;
                }
            });
        });
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –±–∏—Ç—ã—Ö —Å—Å—ã–ª–æ–∫ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        const images = document.querySelectorAll('.product-image img');
        images.forEach(img => {
            img.onerror = function() {
                this.onerror = null;
                this.src = this.getAttribute('data-fallback');
            };
        });
    });
</script>
{% endblock %}
